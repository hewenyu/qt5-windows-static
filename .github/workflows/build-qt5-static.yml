name: Build Qt5 Static Libraries

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  QT_VERSION: 5.15.2
  VSVER: 2019
  SHORT_ROOT: C:\qt

jobs:
  build:
    runs-on: windows-2019
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Build Directory
      shell: cmd
      run: |
        mkdir %SHORT_ROOT%
        xcopy /E /I /H %GITHUB_WORKSPACE% %SHORT_ROOT%\src\
    
    - name: Cache Qt5 static build
      id: cache-qt
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.SHORT_ROOT }}\qt5-static
        key: qt5-static-${{ env.QT_VERSION }}-msvc${{ env.VSVER }}
        
    - name: Download Qt Source
      if: steps.cache-qt.outputs.cache-hit != 'true'
      working-directory: ${{ env.SHORT_ROOT }}
      run: |
        curl -L --output qt.zip https://download.qt.io/official_releases/qt/5.15/${{ env.QT_VERSION }}/single/qt-everywhere-src-${{ env.QT_VERSION }}.zip
        7z x qt.zip -oqt5-static
      shell: pwsh
      
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Setup Visual Studio Environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        vsversion: ${{ env.VSVER }}
      
    - name: Configure Qt
      if: steps.cache-qt.outputs.cache-hit != 'true'
      working-directory: ${{ env.SHORT_ROOT }}/qt5-static/qt-everywhere-src-${{ env.QT_VERSION }}
      shell: cmd
      run: |
        mkdir build
        cd build
        call ..\configure.bat -static -debug-and-release -platform win32-msvc -prefix "${{ env.SHORT_ROOT }}\qt5-static\installed" ^
        -opensource -confirm-license -nomake examples -nomake tests ^
        -skip qtwebengine ^
        -skip qtlocation ^
        -skip qtwebchannel ^
        -skip qtwebsockets ^
        -skip qtwebview ^
        -skip qtwebglplugin ^
        -feature-accessibility ^
        -feature-concurrent ^
        -feature-xml ^
        -feature-sql ^
        -feature-sql-sqlite ^
        -feature-network ^
        -feature-opengl ^
        -feature-testlib ^
        -qt-zlib ^
        -qt-libpng ^
        -qt-libjpeg ^
        -qt-freetype ^
        -qt-pcre ^
        -qt-harfbuzz ^
        -openssl-linked ^
        -feature-dbus ^
        -feature-qml-debug ^
        -feature-quick-designer ^
        -feature-windeployqt ^
        -feature-linguist ^
        -feature-pdf ^
        -feature-printer ^
        -feature-widgets ^
        -feature-quickwidgets ^
        -feature-quickparticles ^
        -feature-shadertools ^
        -feature-vulkan ^
        -mp -optimize-size
      
    - name: Build Qt
      if: steps.cache-qt.outputs.cache-hit != 'true'
      working-directory: ${{ env.SHORT_ROOT }}/qt5-static/qt-everywhere-src-${{ env.QT_VERSION }}/build
      shell: cmd
      run: |
        nmake
        nmake install
        
    - name: Copy Build Results
      shell: cmd
      run: |
        xcopy /E /I /H %SHORT_ROOT%\qt5-static\installed %GITHUB_WORKSPACE%\qt5-static\installed\
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: qt5-static-msvc${{ env.VSVER }}
        path: qt5-static/installed
        retention-days: 90 